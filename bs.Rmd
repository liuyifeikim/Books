---
title: "Untitled"
output: html_document
date: '2022-10-08'
---


https://github.com/business-science/free_r_tips


# 001_read_multiple_files

```{r}
library(tidyverse)
library(fs)
```

```{r}
# 分割数据并导出
mpg %>%
    group_by(manufacturer) %>%
    group_split() %>%
    walk(function(x) {
        write_csv(x, path = str_c("./001_read_multiple_files/", unique(x$manufacturer), ".csv"))
    })
```

```{r}
file_paths <- fs::dir_ls("001_read_multiple_files")
file_paths
```

```{r}
file_contents <- list()
for (i in seq_along(file_paths)) {
    file_contents[[i]] <- read_csv(
        file = file_paths[[i]]
    )
}
file_contents <- set_names(file_contents, file_paths)
file_contents
```

```{r}
file_paths %>%
    map(function(path) {
        read_csv(path)
    })
```


# 002_scraping_word_docs

```{r}
library(officer)
library(janitor)
library(ggtext)
library(tidyverse)
```

```{r}
doc <- read_docx("002_scraping_word_docs/Business Science.docx")
doc
```


```{r}
content_tbl <- docx_summary(doc) %>% as_tibble()
content_tbl
table_content_tbl <- content_tbl %>% filter(content_type == "table cell")
table_content_tbl
```

```{r}
table_header <- table_content_tbl %>%
    filter(is_header) %>%
    pull(text)
table_header
```


```{r}
lecture_analysis_tbl <- table_content_tbl %>%
    filter(!is_header) %>%
    select(text, row_id, cell_id) %>%
    pivot_wider(names_from = cell_id, values_from = text) %>%
    select(-row_id) %>%
    mutate(across(.cols = -1, .fns = parse_number)) %>%
    set_names(table_header) %>%
    clean_names() %>%
    mutate(activity_ratio = lectures_completed / students)
lecture_analysis_tbl
```

```{r}
lecture_analysis_tbl %>%
    ggplot(aes(students, lectures_completed)) +
    geom_point(aes(size = activity_ratio)) +
    geom_smooth(method = "loess") +
    geom_richtext(
        aes(label = str_glue("___Course: {course}___<br>Ratio: {round(activity_ratio)}")),
        vjust = "inward", hjust = "inward", size = 3.5
    ) +
    labs(
        title = "Lessons Completed Vs Students",
        x = "No. of Students", y = "No. of Lessons Completed"
    ) +
    scale_y_continuous(label = scales::comma) +
    expand_limits(y = 0) +
    theme_minimal()
```

# 003_powerpoint_slidedeck

```{r}
library(officer)
library(flextable)
library(tidyverse)
library(tidyquant)
library(timetk)
```

```{r}
# stock_data_tbl <- c("AAPL", "GOOG", "FB", "NVDA") %>% tq_get(from = "2019-01-01", to = "2020-08-31")
# stock_data_tbl
```


# 008_tidyverse_relocate

```{r}
library(tidyverse)
```

```{r}
mpg
```

```{r}
mpg %>% select(model, manufacturer, class, year)
mpg %>% relocate(model, manufacturer, class, year)
```


```{r}
mpg %>% relocate(manufacturer, .after = class)
mpg %>% relocate(manufacturer, .after = last_col())
mpg %>% relocate(manufacturer, .after = last_col(offset = 1))
```


```{r}
mpg %>% relocate(where(is.numeric))
mpg %>% relocate(where(is.character))
mpg %>% relocate(where(is.character), .after = last_col())
mpg %>% relocate(starts_with("m"), .before = year)
```

# 009_tidyverse_across

```{r}
library(tidyverse)
```

```{r}
mpg %>% View()
```

```{r}
mpg %>%
    group_by(class) %>%
    summarise(
        across(cty, .fns = mean),
        .groups = "drop"
    )
```

```{r}
mpg %>%
    group_by(class) %>%
    summarise(
        across(cty, .fns = list(mean = mean, stdev = sd)), .groups = "drop"
    )
```

```{r}
mpg %>%
    group_by(class) %>%
    summarise(
        across(c(cty, hwy), .fns = list(mean = mean, stdev = sd)), .groups = "drop"
    )
```

```{r}
mpg %>%
    group_by(class) %>%
    summarise(
        across(
            c(cty, hwy),
            .fns = list(mean = mean, stdev = sd),
            .names = "{.fn} {.col} Consumption"
        ),
        .groups = "drop"
    ) %>%
    rename_with(.fn = str_to_upper)
```

```{r}
mpg %>%
    group_by(class) %>%
    summarise(
        across(
            c(cty, hwy),
            .fns = list(
                "mean"     = ~ mean(.x),
                "range lo" = ~ (mean(.x) - 2*sd(.x)),
                "range hi" = ~ (mean(.x) + 2*sd(.x))
            ),
            .names = "{.fn} {.col}"
        ),
        .groups = "drop"
    ) %>%
    rename_with(.fn = str_to_upper)
```


# 010_tidyverse_pivot

```{r}
library(tidyquant)
library(tidyverse)
```

```{r}
mpg_pivot_table_1 <- mpg %>%
    group_by(manufacturer) %>%
    count(class, name = "n") %>%
    ungroup() %>%
    pivot_wider(
        names_from  = class,
        values_from = n,
        values_fill = 0
    )
mpg_pivot_table_1
```


```{r}
mpg_pivot_table_2 <- mpg %>%
    pivot_table(
        .columns = class,
        .rows    = manufacturer,
        .values  = ~ n(),
        fill_na  = 0
    )
mpg_pivot_table_2
```

```{r}
mpg %>%
    pivot_table(
        .rows    = class,
        .values  = ~ list(lm(hwy ~ displ + cyl - 1))
    )
```


```{r}
mpg_long_summary_table <- mpg_pivot_table_1 %>%
    pivot_longer(
        cols      = compact:subcompact,
        names_to  = "class",
        values_to = "value"
    )
mpg_long_summary_table
```

```{r}
mpg_long_summary_table %>%
    ggplot(aes(class, manufacturer, fill = value)) +
    geom_tile() +
    geom_label(aes(label = value), fill = "white") +
    scale_fill_viridis_c() +
    theme_minimal() +
    labs(title = "Class by Auto Manufacturer")
```

# 011_group_split_linear_regression

```{r}
library(tidyquant)
library(tidyverse)
library(broom)
```

```{r}
# devtools::install_github("rstudio/fontawesome")
library(gt)
library(fontawesome)
library(htmltools)
```

```{r}
mpg
```


```{r}
mpg %>%
    mutate(manufacturer = as_factor(manufacturer)) %>%
    group_by(manufacturer) %>%
    group_split()
```


```{r}
mpg %>%
    mutate(manufacturer = as_factor(manufacturer)) %>%
    group_by(manufacturer) %>%
    group_split() %>%
    map(.f = function(df) {
        lm(hwy ~ cty, data = df)
    })
```

```{r}
hwy_vs_city_tbl <- mpg %>%
    mutate(manufacturer = as_factor(manufacturer)) %>%
    group_by(manufacturer) %>%
    group_split() %>%
    map_dfr(.f = function(df) {
        lm(hwy ~ cty, data = df) %>%
            glance() %>%
            add_column(manufacturer = unique(df$manufacturer), .before = 1)
    })
hwy_vs_city_tbl
```


```{r}
rating_stars <- function(rating, max_rating = 5) {
    rounded_rating <- floor(rating + 0.5)  # always round up
    stars <- lapply(seq_len(max_rating), function(i) {
        if (i <= rounded_rating) {
            fontawesome::fa("star", fill= "orange")
        } else {
            fontawesome::fa("star", fill= "grey")
        }
    })
    label <- sprintf("%s out of %s", rating, max_rating)
    div_out <- div(title = label, "aria-label" = label, role = "img", stars)
    as.character(div_out) %>%
        gt::html()
}
rating_stars
```


```{r}
hwy_vs_city_tbl %>%
    select(manufacturer, nobs, r.squared, adj.r.squared, p.value) %>%
    mutate(manufacturer = str_to_title(manufacturer)) %>%
    mutate(rating = cut_number(r.squared, n = 5) %>% as.numeric()) %>%
    mutate(rating = map(rating, rating_stars)) %>%
    arrange(desc(r.squared)) %>%
    gt() %>%
    tab_header(title = gt::md("__Highway vs City Fuel Mileage__")) %>%
    tab_spanner(
        label = gt::html("<small>Relationship Strength (hwy ~ cty)</small>"),
        columns = vars(r.squared, adj.r.squared, p.value)
    ) %>%
    fmt_number(columns = vars(r.squared, adj.r.squared)) %>%
    fmt_number(columns = vars(p.value), decimals = 3) %>%
    tab_style(
        style = cell_text(size = px(12)),
        locations = cells_body(
            columns = vars(r.squared, adj.r.squared, p.value))
    ) %>%
    cols_label(
        manufacturer = gt::md("__MFG__"),
        nobs = gt::md("__#__"),
        r.squared = gt::html(glue::glue("<strong>R-Squared ", fontawesome::fa("arrow-down", fill = "orange"), "</strong>")),
        adj.r.squared = gt::md("__R-Squared (Adj)__"),
        p.value = gt::md("__P-Value__"),
        rating  = gt::md("__Rating__")
    )
```

# 012_nest_arima

```{r}
library(modeltime)
library(tidymodels)
library(timetk)
library(tidyverse)
```

```{r}
walmart_sales_weekly
```


```{r}
walmart_sales_weekly %>%
    group_by(id) %>%
    plot_time_series(Date, Weekly_Sales, .facet_ncol = 2)
```

```{r}
data_nested <- walmart_sales_weekly %>%
    select(id, Date, Weekly_Sales) %>%
    nest(nested_column = -id)
data_nested$nested_column
```


```{r}
data_nested %>%
    unnest(nested_column)
```


```{r}
model_table <- data_nested %>%
    mutate(fitted_model = map(nested_column, .f = function(df) {
        arima_reg(seasonal_period = 52) %>%
            set_engine("auto_arima") %>%
            fit(Weekly_Sales ~ Date, data = df)
    })) %>%
    mutate(nested_forecast = map2(fitted_model, nested_column,
                                  .f = function(arima_model, df) {
        modeltime_table(
            arima_model
        ) %>%
            modeltime_forecast(
                h = 52,
                actual_data = df
            )
    }))
model_table
```

```{r}
model_table %>%
    select(id, nested_forecast) %>%
    unnest(nested_forecast) %>%
    group_by(id) %>%
    plot_modeltime_forecast(.facet_ncol = 2)
```

# 013_ggplot2_maps

```{r}
library(tidyverse)
library(maps)
library(mapproj)
```

```{r}
world_tbl <- map_data("world") %>%
    as_tibble()
world_tbl
```


```{r}
world_base <- world_tbl %>%
    ggplot() +
    geom_map(
        aes(long, lat, map_id = region),
        map = world_tbl,
        color = "gray80", fill = "gray30", size = 0.3
    )
world_base
```


```{r}
world_base +
    coord_map("ortho", orientation = c(39, -98, 0))
```


```{r}
usa_tbl <- map_data("state") %>% as_tibble()
usa_tbl %>%
    ggplot(aes(long, lat, map_id = region)) +
    geom_map(
        map = usa_tbl,
        color = "gray80", fill = "gray30", size = 0.3
    ) +
    coord_map("ortho", orientation = c(39, -98, 0))
```

```{r}
republican_voting_tbl <- maps::votes.repub %>%
    as_tibble(rownames = "state") %>%
    select(state, `1976`) %>%
    rename(repub_prop = `1976`) %>%
    mutate(repub_prop = repub_prop / 100) %>%
    mutate(state = str_to_lower(state))

usa_voting_tbl <- usa_tbl %>%
    left_join(republican_voting_tbl, by = c("region" = "state"))

usa_voting_tbl
```

```{r}
usa_voting_tbl %>%
    ggplot(aes(long, lat, group = subregion)) +
    geom_map(
        aes(map_id = region),
        map = usa_tbl,
        color = "gray80", fill = "gray30", size = 0.3
    ) +
    coord_map("ortho", orientation = c(39, -98, 0)) +
    geom_polygon(aes(group = group, fill = repub_prop), color = "black") +
    scale_fill_gradient2(low = "blue", mid = "white", high = "red",
                         midpoint = 0.5, labels = scales::percent) +
    theme_minimal() +
    labs(
        title = "Voting Republican in 1976",
        x = "", y = "", fill = ""
    ) +
    theme(
        plot.title = element_text(size = 26, face = "bold", color = "red3"),
        legend.position = "bottom"
    )
```

# 014_visualize_pca

```{r}
library(broom)
library(ggfortify)
library(plotly)
library(tidyverse)
```


```{r}
y_tbl <- mpg %>%
    select(manufacturer, model) %>%
    mutate(vehicle = str_c(manufacturer, "_", model)) %>%
    rowid_to_column()
y_tbl
```

```{r}
x_tbl <- mpg %>%
    select(displ:class) %>%
    rowid_to_column() %>%

    # One Hot Encode: transmission
    mutate(
        trans_auto = str_detect(trans, "auto") %>% as.numeric(),
        trans_man  = str_detect(trans, "man") %>% as.numeric()
    ) %>%
    select(-trans) %>%

    # One Hot Encode: drv
    mutate(val_drv = 1) %>%
    pivot_wider(
        names_from  = drv,
        values_from = val_drv,
        values_fill = 0,
        names_prefix = "drv_"
    ) %>%

    # One Hot Encode: class
    mutate(val_class = 1) %>%
    pivot_wider(
        names_from  = class,
        values_from = val_class,
        values_fill = 0,
        names_prefix = "class_"
    ) %>%

    # One Hot Encode: fl
    mutate(val_fl = 1) %>%
    pivot_wider(
        names_from  = fl,
        values_from = val_fl,
        values_fill = 0,
        names_prefix = "fl_"
    )

x_tbl %>% glimpse()
```


```{r}
fit_pca <- prcomp(
    formula = ~ . - rowid,
    data    = x_tbl,
    scale.  = TRUE
)
fit_pca
fit_pca %>% tidy()
```


```{r}
g <- autoplot(

    object = fit_pca,
    x = 1,
    y = 2,

    # Labels
    data = y_tbl,
    label = TRUE,
    label.label = "vehicle",
    label.size = 3,

    # LOADINGS
    loadings.label = TRUE,
    loadings.label.size = 7,

    scale = 0
) +
    labs(title = "Visualizing PCA in R")+
    theme_minimal()

g

plotly::ggplotly(g)
```

# 015_logistic_regression

```{r}
library(tidymodels)
library(vip)
library(tidyverse)
```

```{r}
data_prepared_tbl <- mpg %>%
    select(displ:class) %>%
    mutate(trans = ifelse(str_detect(trans, "auto"), "auto", "manual")) %>%
    relocate(year, .before = 1) %>%
    mutate(year = as.factor(year))
data_prepared_tbl
```

```{r}
set.seed(123)
splits <- data_prepared_tbl %>%
    initial_split(prop = 0.80)
splits
```

```{r}
model_fit_glm <- logistic_reg() %>%
    set_engine("glm") %>%
    fit(year ~ . , data = training(splits))
model_fit_glm
```

```{r}
prediction_class_test <- predict(model_fit_glm, new_data = testing(splits), type = "class")
prediction_prob_test  <- predict(model_fit_glm, new_data = testing(splits), type = "prob")
results_tbl <- bind_cols(
    prediction_class_test,
    prediction_prob_test,
    testing(splits)
)
results_tbl
```

```{r}
results_tbl %>%
    roc_auc(year, .pred_1999)
results_tbl %>%
    roc_curve(year, .pred_1999) %>%
    autoplot(
        options = list(
            smooth = TRUE
        )
    ) +
    labs(title = "Area Under the Curve (AUC): 0.752")
```


```{r}
model_fit_glm$fit %>%
    vip(
        num_features = 20,
        geom         = "point",
        aesthetics   = list(
            size     = 4,
            color    = "#18bc9c"
        )
    ) +
    theme_minimal(base_size = 18) +
    labs(title = "Logistic Regression: Feature Importance")
```


```{r}
data_prepared_tbl %>%
    ggplot(aes(class, hwy, color = year)) +
    geom_boxplot() +
    geom_jitter(alpha = 0.25) +
    theme_minimal(base_size = 18) +
    scale_color_viridis_d(end = 0.4) +
    labs(title = "Older Vehicles have Lower Fuel Economy")
```

# 016_cyberpunk_ggplot

```{r}
library(plotly)
library(tidyverse)
library(timetk)
```

```{r}
walmart_sales_weekly
```

```{r}
g1 <- walmart_sales_weekly %>%
    group_by(id) %>%
    plot_time_series(
        .date_var    = Date,
        .value       = Weekly_Sales,
        .color_var   = id,
        .smooth      = TRUE,
        .facet_ncol  = 3,
        .interactive = FALSE
    )
g1
```


```{r}
walmart_sales_weekly %>%
    ggplot(aes(Date, Weekly_Sales, color = id, group = id)) +
    geom_line() +
    geom_smooth(
        aes(Date, Weekly_Sales),
        inherit.aes = FALSE,
        se = FALSE
    ) +
    facet_wrap(
        facets = ~ id,
        scales = "free_y",
        ncol   = 2
    ) +
    theme_minimal() +
    theme(legend.position = "bottom")
```

```{r}
clrs <- colorRampPalette(c("#00ff9f", "#00b8ff", "#001eff", "#bd00ff", "#d600ff"))(7)
scales::show_col(clrs)
clr_bg   <- "black"
clr_bg2  <- "gray10"
clr_grid <- "gray30"
clr_text <- "#d600ff"
# * Setup a ggplot theme ----
theme_cyberpunk <- function() {
    theme(
        # Plot / Panel
        plot.background = element_rect(fill = clr_bg, colour = clr_bg),
        # plot.margin = margin(1.5, 2, 1.5, 1.5, "cm"),
        panel.background = element_rect(fill = clr_bg, color = clr_bg),
        # Grid
        panel.grid = element_line(colour = clr_grid, size = 1),
        panel.grid.major = element_line(colour = clr_grid, size = 1),
        panel.grid.minor = element_line(colour = clr_grid, size = 1),
        axis.ticks.x = element_line(colour = clr_grid, size = 1),
        axis.line.y = element_line(colour = clr_grid, size = 0.5),
        axis.line.x = element_line(colour = clr_grid, size = 0.5),
        # Text
        plot.title = element_text(colour = clr_text),
        plot.subtitle = element_text(colour = clr_text),
        axis.text = element_text(colour = clr_text),
        axis.title = element_text(colour = clr_text),
        # Legend
        legend.background = element_blank(),
        legend.key = element_blank(),
        legend.title = element_text(colour = clr_text),
        legend.text = element_text(colour = "gray80", size = 12, face = "bold"),
        # Strip
        strip.background = element_rect(fill = clr_bg2, color = clr_bg2)
    )
}
```


```{r}
g_cyberpunk <- g1 +
    geom_area(position = "identity", alpha = 0.5) +
    geom_line(aes(color = id), size = 1) +
    scale_color_manual(values = clrs) +
    geom_smooth(
        aes(Date, Weekly_Sales),
        inherit.aes = FALSE,
        se = FALSE
    ) +
    scale_y_continuous(labels = scales::dollar) +
    # facet_wrap(facets = NULL) +
    labs(title = "Cyberpunk 2077 Theme", subtitle = "Time Series Plot") +
    theme_cyberpunk()
g_cyberpunk
ggplotly(g_cyberpunk)
```

# 017_keyboard_shortcuts

```{r}
library(tidyverse)
library(timetk)
library(modeltime)
```

```{r}
m4_monthly %>%
    group_by(id) %>%
    plot_time_series(date, value)
```

```{r}
a <- 1

add2 <- function(x, y) {
    x + y
}

add2(3, 4)
```

# 018_rayshader

```{r}
library(rayshader)
library(tidyverse)
```


```{r}
g1 <- mtcars %>%
    ggplot(aes(disp, mpg, color = cyl)) +
    geom_point(size=2) +
    scale_color_continuous(limits=c(0,8)) +
    ggtitle("mtcars: Displacement vs mpg vs # of cylinders") +
    theme(title = element_text(size=8),
          text = element_text(size=12))
g1
```


```{r}
g1 %>%
    plot_gg(
        height        = 3,
        width         = 3.5,
        multicore     = TRUE,
        pointcontract = 0.7,
        soliddepth    = -200
    )
render_camera(zoom = 0.75, theta = -30, phi = 30)
render_snapshot(clear = FALSE)
```

```{r}
volcano
volcano %>% class()
volcano_tbl <- volcano %>%
    as_tibble(.name_repair = "minimal") %>%
    set_names(str_c("V", seq_along(names(.)))) %>%
    rowid_to_column(var = "x") %>%
    pivot_longer(
        cols      = contains("V"),
        names_to  = "y",
        values_to = "value"
    ) %>%
    mutate(y = str_remove(y, "^V") %>% as.numeric())
volcano_tbl
```


```{r}
g2 <- volcano_tbl %>%
    ggplot(aes(x = x, y = y, fill = value)) +
    geom_tile() +
    geom_contour(aes(z = value), color = "black") +
    scale_x_continuous("X", expand = c(0,0)) +
    scale_y_continuous("Y",expand = c(0,0)) +
    scale_fill_gradientn("Z", colours = terrain.colors(10)) +
    coord_fixed()
g2
```

```{r}
g2 %>%
    plot_gg(
        multicore = TRUE,
        raytrace = TRUE,
        width = 7,
        height = 4,
        scale = 300,
        windowsize = c(1400, 866),
        zoom = 0.6,
        phi = 30,
        theta = 30
    )
```

```{r}
volcano %>%
    sphere_shade() %>%
    plot_3d(volcano, zscale = 3)
```

# 019_missing_data

```{r}
library(visdat)
library(naniar)
library(simputation)
library(tidyverse)
```


```{r}
air_quality_tbl <- airquality %>% as_tibble()
air_quality_tbl
```

```{r}
air_quality_tbl %>% vis_dat()
air_quality_tbl %>% vis_miss()
air_quality_tbl %>% gg_miss_upset()
```

```{r}
air_quality_tbl %>%
    ggplot(aes(x = Solar.R, y = Ozone)) +
    geom_miss_point()
```


```{r}
air_quality_tbl %>%
    # Label if Ozone is missing
    add_label_missings(Ozone) %>%
    # Imputation - Linear Regression
    mutate(Ozone = as.double(Ozone)) %>%
    impute_lm(Ozone ~ Temp + Wind) %>%
    # Visualize
    ggplot(aes(Solar.R, Ozone, color = any_missing)) +
    geom_point()
```

```{r}
air_quality_tbl %>%
    # Label if Ozone is missing
    add_label_missings(Ozone) %>%
    # Imputation - Ozone
    mutate(Ozone = as.double(Ozone)) %>%
    impute_rf(Ozone ~ Temp + Wind) %>%
    # Imputation - Solar.R
    mutate(Solar.R = as.double(Solar.R)) %>%
    impute_rf(Solar.R ~ Temp + Wind) %>%
    # Visualize
    ggplot(aes(Solar.R, Ozone, color = any_missing)) +
    geom_point()
```

# 021_make_dataframes_in_r

```{r}
library(readxl)
library(writexl)
library(plotly)
library(tidyverse)
```

```{r}
df <- tibble(a = 1:10)
class(df)
is.data.frame(df)
```

```{r}
interest_rate_tbl <- readxl::read_xlsx("021_make_dataframes_in_r/interest_rate.xlsx",sheet = 1)
interest_rate_tbl
g <- interest_rate_tbl %>%
    ggplot(aes(date, interest_rate)) +
    geom_line() +
    geom_hline(yintercept = 0, color = "gray50")
ggplotly(g)
```


```{r}
moneyball_list <- list(
    user_name = c("Bill James",
                  "Billy Beane",
                  "Peter Brand",
                  "Art Howe"),
    email     = c(
        "bill.james@gmail.com",
        "billy.beane@gmail.com",
        "peter.brand@harvard.edu",
        "art.howe@hotmail.com"
    ),
    tags      = list(
        list("writer", "baseball", "stats"),
        list("GM", "baseball"),
        list("analyst", "baseball", "stats"),
        list("coach", "baseball")
    )
)
moneyball_list
moneyball_list %>% as_tibble()
```

```{r}
enframe(c("blah", "blah", "blah"), name = "name", value = "contents") %>% deframe()
enframe(moneyball_list) %>%
    pivot_wider(
        names_from  = name,
        values_from = value
    ) %>%
    unnest(user_name:tags) %>%
    unnest(tags) %>%
    unnest(tags)
```

```{r}
interest_rate_tbl <- tibble(
    date          = timetk::tk_make_timeseries("2010", length_out = 12, by = "year"),
    interest_rate = (seq(12, 3, length.out = 12) * (sin(1:12) + 2)) / 12
)
interest_rate_tbl %>% writexl::write_xlsx("021_make_dataframes_in_r/interest_rate.xlsx")
```


# 022_ggstatsplot

```{r}
library(ggstatsplot)
library(tidyverse)
```


```{r}
txhousing
```


```{r}
set.seed(123)
txhousing_sampled_tbl <- txhousing %>%
    dplyr::sample_frac(size = 0.10)
txhousing_sampled_tbl
```


```{r}
txhousing_sampled_tbl %>%
    ggcorrmat(
        cor.vars    = sales:date,
        matrix.type = "upper",
        sig.level   = 0.05
    )
```


```{r}
top_5_cities <- txhousing_sampled_tbl %>%
    count(city, sort = TRUE) %>%
    slice(1:5) %>%
    pull(city)
top_5_cities
```


```{r}
txhousing_sampled_tbl %>%
    filter(city %in% top_5_cities) %>%
    ggbetweenstats(
        x = city,
        y = median,
        type = "robust",
        # Tag outliers
        outlier.tagging    = TRUE,
        outlier.label.args = list(color = "red", size = 3),
        title = "Comparison of Median Home Prices, Top 5 Texas Cities"
    )
```

# 023_ppscore_vs_correlationfunnel

```{r}
library(ppsr) # devtools::install_github('https://github.com/paulvanderlaken/ppsr')
library(correlationfunnel)
library(tidyverse)
```


```{r}
customer_churn_tbl %>% glimpse()
```


```{r}
churn_ppsr_score <- customer_churn_tbl %>%
    select(-customerID) %>%
    score_predictors(y = 'Churn', do_parallel = TRUE) %>%
    as_tibble()
churn_ppsr_score %>% glimpse()
churn_ppsr_score
```

```{r}
customer_churn_tbl %>%
    select(-customerID) %>%
    visualize_pps(y = "Churn", do_parallel = TRUE)
```


```{r}
g <- customer_churn_tbl %>%
    select(-customerID) %>%
    visualize_pps(do_parallel = TRUE)
g + theme(axis.text.x = element_text(angle = 45, hjust = 1))
```


```{r}
customer_churn_binned_tbl <- customer_churn_tbl %>%
    select(-customerID) %>%
    mutate(TotalCharges = ifelse(is.na(TotalCharges), 0, TotalCharges)) %>%
    binarize()
customer_churn_binned_tbl %>% glimpse()
customer_churn_binned_tbl %>%
    correlate(target = Churn__Yes) %>%
    plot_correlation_funnel() +
    geom_point(size = 3, color = "#2c3e50")
```


```{r}
library(tidymodels)
library(xgboost)
library(vip)
recipe_spec <- recipe(Churn ~ ., data = customer_churn_tbl) %>%
    step_rm(customerID) %>%
    step_dummy(all_nominal(), -Churn)
recipe_spec %>% prep() %>% juice() %>% glimpse()
wflw_fit_xgb <- workflow() %>%
    add_model(boost_tree(mode = "classification") %>% set_engine("xgboost")) %>%
    add_recipe(recipe_spec) %>%
    fit(customer_churn_tbl)
wflw_fit_xgb$fit$fit$fit %>% vip()
```

# 024_shiny_in_rmarkdown


# 025_eda_dataexplorer

```{r}
library(DataExplorer)
library(tidyverse)
```

```{r}
gss_cat
gss_cat %>% glimpse()
```

```{r}
gss_cat %>%
    create_report(
        output_file  = "gss_survey_data_profile_report",
        output_dir   = "025_eda_dataexplorer/",
        y            = "rincome",
        report_title = "EDA Report - GSS Demographic Survey"
    )
```

```{r}
gss_cat %>% introduce()
gss_cat %>% plot_intro()
```

```{r}
gss_cat %>% plot_missing()
gss_cat %>% profile_missing()
```

```{r}
gss_cat %>% plot_density()
gss_cat %>% plot_histogram()
```

```{r}
gss_cat %>% plot_bar()
```

```{r}
gss_cat %>% plot_correlation(maxcat = 15)
```

# 026_eda_skimr

```{r}
library(skimr)
library(tidyverse)
```

```{r}
starwars
```

```{r}
starwars %>% skim()
starwars %>% filter(is.na(birth_year))
```

```{r}
storms %>% skim()
```

```{r}
economics %>% skim()
economics_long %>% group_by(variable) %>% skim()
```

# 028_esquisse_ggplot_builder

```{r}
library(esquisse)
library(modeldata)
library(tidyverse)
```


```{r}
data("drinks")
data("mpg")
drinks
mpg
```


```{r}
esquisser()
```

```{r}
drinks %>%
    filter(date >= "2005-01-14" & date <= "2014-01-22") %>%
    ggplot() +
    aes(x = date, y = S4248SM144NCEN) +
    geom_line(size = 1.34, colour = "#909495") +
    labs(title = "My awesome plot", subtitle = "This is a time series") +
    theme_minimal()
```

```{r}
ggplot(mpg) +
    aes(x = displ, y = hwy, colour = drv) +
    geom_point(size = 3L) +
    geom_smooth(span = 1L) +
    scale_color_viridis_d(option = "cividis") +
    theme_minimal()
```

# 031_dtplyr

```{r}
library(tidyverse)
library(dtplyr)
library(tidyquant)
```

```{r}
mpg_dt <- lazy_dt(mpg)
mpg_dt
```

```{r}
mpg_summary_dt <- mpg_dt %>%
    group_by(manufacturer, cyl) %>%
    summarise(across(
        .cols  = c(displ, cty:hwy),
        .fns   = list(mean, median),
        .names = "{.fn}_{.col}"
    )) %>%
    ungroup()
mpg_summary_dt
```

```{r}
mpg_summary_dt %>% show_query()
mpg_summary_tbl <- mpg_summary_dt %>% collect()
mpg_summary_tbl
```

```{r}
mpg_summary_tbl %>%
    ggplot(aes(manufacturer, factor(cyl), fill = mean_cty)) +
    geom_tile() +
    geom_text(aes(label = round(mean_cty, 1)), size = 3) +
    scale_fill_viridis_c(direction = 1) +
    labs(title = "Average City Fuel Mileage by Engine Size (Cylinders)",
         x = "Manufacturer", y = "Engine Size (Cylinders",
         fill = "Average City Mileage") +
    coord_flip() +
    tidyquant::theme_tq()
```

# 032_datapasta

```{r}
library(datapasta)
library(tidyverse)
library(lubridate)
library(timetk)
```


```{r}
stock_data <- tibble::tribble(
                           ~Date,  ~Open,  ~High,   ~Low, ~`Close*`, ~`Adj.Close**`,     ~Volume,
                  "Apr 12, 2021", 132.52, 132.85, 130.63,    131.24,         131.24,    91286600,
                  "Apr 09, 2021",  129.8, 133.04, 129.47,       133,            133,   106513800,
                  "Apr 08, 2021", 128.95, 130.39, 128.52,    130.36,         130.36,    88844600,
                  "Apr 07, 2021", 125.83, 127.92, 125.14,     127.9,          127.9,    83466700,
                  "Apr 06, 2021",  126.5, 127.13, 125.65,    126.21,         126.21,    80171300,
                  "Apr 05, 2021", 123.87, 126.16, 123.07,     125.9,          125.9,    88651200,
                  "Apr 01, 2021", 123.66, 124.18, 122.49,       123,            123,    74957400,
                  "Mar 31, 2021", 121.65, 123.52, 121.15,    122.15,         122.15,   118323800,
                  "Mar 30, 2021", 120.11,  120.4, 118.86,     119.9,          119.9,    85671900,
                  "Mar 29, 2021", 121.65, 122.58, 120.73,    121.39,         121.39,    80819200,
                  "Mar 26, 2021", 120.35, 121.48, 118.92,    121.21,         121.21,    93958900,
                  "Mar 25, 2021", 119.54, 121.66,    119,    120.59,         120.59,    98844700,
                  "Mar 24, 2021", 122.82,  122.9, 120.07,    120.09,         120.09,    88530500,
                  "Mar 23, 2021", 123.33, 124.24, 122.14,    122.54,         122.54,    95467100,
                  "Mar 22, 2021", 120.33, 123.87, 120.26,    123.39,         123.39,   111912300
                  )
stock_data %>%
    mutate(Date = mdy(Date)) %>%
    plot_time_series(Date, Volume)
```


```{r}
largest_companies_dt <- data.table::data.table(
                                  V1 = c(1L,2L,3L,4L,5L,6L,7L,8L,9L,
                                         10L),
                                  V2 = c("Walmart","Sinopec Group",
                                         "Amazon","State Grid",
                                         "China National Petroleum","Royal Dutch Shell",
                                         "Saudi Aramco","Volkswagen","BP","Toyota"),
                                  V3 = c("Retail","Oil and gas","Retail",
                                         "Electricity","Oil and gas",
                                         "Oil and gas","Oil and gas","Automotive",
                                         "Oil and gas","Automotive"),
                                  V4 = c("Increase $559,200",
                                         "Decrease $407,009","Increase $386,064",
                                         "Decrease $383,906","Decrease $379,130",
                                         "Decrease $344,379","Decrease $329,784",
                                         "Increase $282,760","Decrease $282,610",
                                         "Increase $275,288"),
                                  V5 = c("$19,742","$6,793","$17,377",
                                         "$7,970","$4,433","$15,842","$88,211",
                                         "$15,542","$4,026","$19,096"),
                                  V6 = c(2200000,582648,1125300,907677,
                                         1344410,83000,79000,671205,72500,
                                         359542),
                                  V7 = c("United States United States",
                                         "China China",
                                         "United States United States","China China","China China",
                                         "Netherlands Netherlands",
                                         "Saudi Arabia Saudi Arabia","Germany Germany",
                                         "United Kingdom United Kingdom","Japan Japan"),
                                  V8 = c("[4]","[5]","[6]","[7]","[8]",
                                         "[9]","[10]","[11]","[12]","[13]")
                        )
largest_companies_dt
largest_companies_dt %>%
    mutate(
        V4 = parse_number(V4),
        V2 = as_factor(V2) %>% fct_rev()
    ) %>% 
  as.data.frame() %>% 
    ggplot(aes(V4, V2)) +
    geom_col(aes(fill = V4)) +
    geom_label(aes(label = scales::dollar_format()(V4)), hjust=1) +
    theme_minimal() +
    scale_x_continuous(labels = scales::dollar_format()) +
    labs(title = "Revenue (Millions) for Largest Companies") +
    theme(legend.position = 'none')
```

# 033_corrmorant

```{r}
library(corrmorant)
library(tidyverse)
```

```{r}
corrmorant(mpg)
corrmorant(mpg, style = "dark")
corrmorant(mpg, style = "dark") +
    theme_dark() +
    labs(title = "Correlations")
```


```{r}
ggcorrm(data = mpg) +
    lotri(geom_point(alpha = 0.5)) +
    lotri(geom_smooth()) +
    utri_heatmap() +
    utri_corrtext() +
    dia_names(y_pos = 0.15, size = 3) +
    dia_histogram(lower = 0.3, fill = "grey80", color = 1) +
    scale_fill_corr() +
    labs(title = "Correlation Plot")
```


```{r}
corfun <- function(x, y)  round(cor(x, y,method = "pearson", use = "pairwise.complete.obs"), 2)
ggcorrm(
        mapping = aes(col = cyl, fill = cyl),
        data    = mpg %>% mutate(cyl = factor(cyl)),
        bg_dia  = "grey30"
    ) +
    lotri(geom_point(alpha = 0.5)) +
    lotri(geom_smooth(se=F, method = "lm")) +
    utri_funtext(fun = corfun, size = 6) +
    dia_names(y_pos = 0.15, size = 3) +
    dia_density(lower = 0.3, fill = "grey60", color = 1) +
    theme_dark() +
    scale_color_viridis_d() +
    scale_fill_viridis_d() +
    labs(title = "Correlation Plot")
```

# 034_mmtable2_ggplot_tables

```{r}
library(mmtable2)
library(gt)
library(tidyverse)
```

```{r}
data_wrangled <- mpg %>%
    group_by(manufacturer, cyl) %>%
    summarise(across(.cols = c(cty, hwy), .fns = mean)) %>%
    ungroup() %>%
    pivot_longer(
        cols = c(cty, hwy),
        names_to = "fuel_economy_type",
        values_to = "fuel_economy"
    )
data_wrangled
```

```{r}
main_table <- data_wrangled %>%
    mutate(fuel_economy = round(fuel_economy, 1)) %>%
    mmtable(cells = fuel_economy, table_name = "Fuel Economy") +
    # Specify Headers
    header_top(manufacturer) +
    header_left(cyl) +
    header_left_top(fuel_economy_type) +
    # Specify formatting
    header_format(manufacturer, list(cell_text(transform = "capitalize"))) +
    header_format(fuel_economy_type, list(cell_text(transform = "uppercase"))) +
    table_format(
        locations = list(
            cells_body(rows = c(2, 6))
        ),
        style     = list(
            cell_borders(sides = "top", color = "grey")
        )
    )

main_table %>%
    gt::tab_header(
        title = "Fuel Economy by Car Manufacturer",
        subtitle = "Audi, VW, and Honda are leaders in Fuel Economy"
    )
```

# 035_patchwork

```{r}
library(patchwork)
library(ggridges)
library(ggrepel)
library(maps)
library(tidyverse)
library(lubridate)
```

```{r}
txhousing_tbl <- txhousing %>%
    mutate(date = lubridate::make_date(year, month))
txhousing_tbl
```

```{r}
gg_tx_timeseries <- txhousing_tbl %>%
    ggplot(aes(date, median, group = city)) +
    geom_line(color = "gray20", alpha = 0.25) +
    geom_smooth(
        aes(group = NULL),
        method = "loess",
        span = 0.1,
        se = FALSE,
        size = 2.5,
        color = "black"
    ) +
    theme_minimal() +
    scale_y_continuous(labels = scales::dollar_format()) +
    labs(y = "", x = "", title = "Median Home Price Over Time")
gg_tx_timeseries
```


```{r}
gg_tx_ridge <- txhousing_tbl %>%
    drop_na() %>%
    mutate(city = factor(city) %>% fct_reorder(median) %>% fct_rev()) %>%
    filter(as.numeric(city) %in% (1:10)) %>%
    ggplot(aes(x = median, y = fct_rev(city))) +
    geom_density_ridges(
        color = "#18BC9C",
        fill  = "gray10",
        alpha = 0.75,
        size  = 1
    ) +
    scale_x_continuous(labels = scales::dollar_format()) +
    theme_minimal() +
    labs(x = "Median Home Price", y = "", title = "Top 10 Cities by Median Home Price")
gg_tx_ridge
```


```{r}
texas_housing_tbl <- txhousing_tbl %>%
    group_by(city) %>%
    summarise(median = median(median, na.rm = T)) %>%
    ungroup() %>%
    mutate(city = str_to_lower(city))

texas_cities_tbl <- us.cities %>%
    filter(country.etc == "TX") %>%
    mutate(name = name %>%
               str_sub(end = nchar(name) - 3) %>%
               str_to_lower() %>%
               str_trim()
    ) %>%
    left_join(texas_housing_tbl, by = c("name" = "city"))

texas_outline_tbl <- map_data("state", region = "texas") %>% as_tibble()

gg_tx_map <- texas_cities_tbl %>%
    drop_na() %>%
    ggplot(aes(x = long, y = lat, size = median)) +
    geom_polygon(
        data  = texas_outline_tbl,
        aes(x = long, y = lat, group = group, size = NULL),
        color = "black",
        size = 1.5,
        fill = "#18bc9c"
    ) +
    geom_point() +
    geom_text_repel(aes(label = str_to_title(name)), max.overlaps = 5) +
    # scale_color_viridis_c() +
    coord_map() +
    theme_void() +
    labs(title = "Median Home Prices by City", x = "", y = "") +
    theme(legend.position = "none")

gg_tx_map
```

```{r}
gg_tx_map + (gg_tx_timeseries / gg_tx_ridge) +
    plot_layout(widths = c(3,2), tag_level = "new") +
    plot_annotation(
        title      = "Texas Real-Estate Statistics",
        subtitle   = "The untold secrets of prime-real estate in the Lonestar State.\n",
        tag_levels = "A",
        tag_prefix = "Fig. ",
        tag_suffix = ":"
    ) &
    theme(plot.tag.position = c(0, 1),
          plot.tag = element_text(size = 8, hjust = 0, vjust = 0))
```

# 036_ggside

```{r}
library(ggside)
library(tidyverse)
library(tidyquant)
```

```{r}
mpg %>%
    ggplot(aes(hwy, cty, color = class)) +
    geom_point(size = 2, alpha = 0.3) +
    geom_smooth(aes(color = NULL), se=TRUE) +
    geom_xsidedensity(
        aes(
            y    = after_stat(density),
            fill = class
        ),
        alpha    = 0.5,
        size     = 1
        ,
        position = "stack"
    ) +
    geom_ysidedensity(
        aes(
            x    = after_stat(density),
            fill = class
        ),
        alpha    = 0.5,
        size     = 1
        ,
        position = "stack"
    ) +
    scale_color_tq() +
    scale_fill_tq() +
    theme_tq() +
    labs(title = "Fuel Economy by Vehicle Type" ,
         subtitle = "ggside density",
         x = "Highway MPG", y = "City MPG") +
    theme(
        ggside.panel.scale.x = 0.4,
        ggside.panel.scale.y = 0.4
    )
```

```{r}
mpg %>%
    ggplot(aes(x = cty, y = hwy, color = class)) +
    geom_point() +
    geom_smooth(aes(color = NULL)) +
    geom_xsideboxplot(
        alpha    = 0.5,
        size     = 1
    ) +
    scale_color_tq() +
    scale_fill_tq() +
    theme_tq() +
    facet_grid(cols = vars(cyl), scales = "free_x") +
    labs(
        title = "Fuel Economy by Engine Size (Cylinders)"
    ) +
    theme(
        ggside.panel.scale.x = 0.4
    )
```

# 037_dataeditr

```{r}
library(DataEditR)
library(tidyverse)
library(tidyquant)
```

```{r}
mpg_subset <- data_edit(x = mpg)
```

```{r}
mpg %>%
    select(manufacturer, model, cty, hwy, class) %>%
    pivot_longer(cols = c(cty, hwy)) %>%
    mutate(
        model = fct_reorder(
            str_glue("{manufacturer} {model}") %>% str_to_title(),
            value
        ),
        name = str_to_upper(name)
    ) %>%
    ggplot(aes(x = model, y = value, fill = class)) +
    geom_boxplot() +
    facet_grid(cols = vars(name), scales = "free_y") +
    coord_flip() +
    scale_fill_tq() +
    theme_tq() +
    labs(title = "Fuel Economy by Model", y = "MPG", x = "")
```

# 038_gghalves

```{r}
library(tidyverse)
library(tidyquant)
library(gghalves)
```

```{r}
mpg %>%
    filter(cyl != 5) %>%
    mutate(cyl = factor(cyl)) %>%
    ggplot(aes(cyl, hwy)) +
    geom_jitter() +
    theme_tq()
```


```{r}
mpg %>%
    filter(cyl != 5) %>%
    mutate(cyl = factor(cyl)) %>%
    ggplot(aes(cyl, hwy)) +
    geom_boxplot(outlier.colour = "red") +
    theme_tq()
```


```{r}
mpg %>%
    filter(cyl != 5) %>%
    mutate(cyl = factor(cyl)) %>%
    ggplot(aes(cyl, hwy, color = cyl)) +
    geom_half_boxplot(outlier.color = "red") +
    geom_half_dotplot(
        aes(fill = cyl),
        dotsize = 0.75,
        stackratio = 0.5,
        color = "black"
    ) +
    facet_grid(cols = vars(cyl), scales = "free_x") +
    scale_color_tq() +
    scale_fill_tq() +
    theme_tq() +
    labs(
        title = "Highway Fuel Economy by Engine Size",
        subtitle = "Half-Boxplot + Half-Dotplot"
    )
```

```{r}
mpg %>%
    filter(cyl == 6) %>%
    ggplot(aes(class, hwy, fill = class)) +
    geom_boxplot() +
    scale_fill_tq() +
    theme_tq() +
    labs(title = "6 Cylinder Vehicles: Pickup and SUV causing Bi-Modal Relationship")
```

```{r}
mpg %>%
    filter(cyl == 6) %>%
    ggplot(aes(class, hwy, fill = class)) +
    geom_half_boxplot(
        outlier.colour = "red"
    ) +
    geom_half_dotplot(
        aes(fill = class),
        dotsize = 0.75,
        stackratio = 0.5,
        color = "black"
    ) +
    scale_color_tq() +
    scale_fill_tq() +
    theme_tq() +
    labs(title = "6 Cylinder Vehicles: Pickup and SUV causing Bi-Modal Relationship")
```

# 039_grafify

```{r}
library(tidyverse)
library(grafify)
```

```{r}
mpg %>%
    plot_scatterbar_sd(cyl, hwy)
```

```{r}
mpg %>%
    plot_scatterbox(cyl, hwy, jitter = 0.2, s_alpha = 0.5)
```

```{r}
mpg %>%
    plot_dotviolin(cyl, hwy, dotsize = 0.4, ColPal = "bright")
```

```{r}
mpg %>%
    plot_3d_scatterbox(cyl, hwy, class, s_alpha = 0)
```

```{r}
mpg %>%
    group_by(model, year) %>%
    summarize(mean_hwy = mean(hwy)) %>%
    ungroup() %>%
    plot_befafter_colors(year, mean_hwy, model)
```

# 040_modeltime_forecasting

```{r}
library(modeltime)
library(tidymodels)
library(tidyverse)
library(timetk)
library(lubridate)
```

```{r}
bike_sharing_daily
data <- bike_sharing_daily %>%
    select(dteday, cnt)
data %>% plot_time_series(dteday, cnt)
```

```{r}
splits <- time_series_split(
    data,
    assess     = "3 months",
    cumulative = TRUE
)
splits %>%
    tk_time_series_cv_plan() %>%
    plot_time_series_cv_plan(dteday, cnt)
```

```{r}
model_arima <- arima_reg() %>%
    set_engine("auto_arima") %>%
    fit(cnt ~ dteday, training(splits))
model_arima
```

```{r}
model_prophet <- prophet_reg(
        seasonality_yearly = TRUE
    ) %>%
    set_engine("prophet") %>%
    fit(cnt ~ dteday, training(splits))
model_prophet
```

```{r}
model_glmnet <- linear_reg(penalty = 0.01) %>%
    set_engine("glmnet") %>%
    fit(
        cnt ~ wday(dteday, label = TRUE)
            + month(dteday, label = TRUE)
            + as.numeric(dteday),
        training(splits)
    )
model_glmnet
```

```{r}
model_tbl <- modeltime_table(
    model_arima,
    model_prophet,
    model_glmnet
)
calib_tbl <- model_tbl %>%
    modeltime_calibrate(testing(splits))
calib_tbl %>% modeltime_accuracy()
```

```{r}
calib_tbl %>%
    modeltime_forecast(
        new_data    = testing(splits),
        actual_data = data
    ) %>%
    plot_modeltime_forecast()
```

```{r}
future_forecast_tbl <- calib_tbl %>%
    modeltime_refit(data) %>%
    modeltime_forecast(
        h           = "3 months",
        actual_data = data
    )
future_forecast_tbl %>%
    plot_modeltime_forecast()
```

# 041_easystats_performance

```{r}
library(tidyverse)
library(performance)
library(tidymodels)
```

```{r, fig.width=15, fig.height=8}
model_lm <- lm(hwy ~ displ + class, data = mpg)
model_lm
check_model(model_lm)
```


```{r, fig.width=15, fig.height=8}
model_lm_tidy <- linear_reg() %>%
    set_engine("lm") %>%
    fit(hwy ~ displ + class, data = mpg)
check_model(model_lm_tidy)
```

# 042_raincloud_plots

```{r}
library(ggdist)
library(tidyquant)
library(tidyverse)
```

```{r}
mpg %>%
    filter(cyl %in% c(4,6,8)) %>%
    ggplot(aes(x = factor(cyl), y = hwy, fill = factor(cyl))) +
    # add half-violin from {ggdist} package
    ggdist::stat_halfeye(
        ## custom bandwidth
        adjust = 0.5,
        ## move geom to the right
        justification = -.2,
        ## remove slab interval
        .width = 0,
        point_colour = NA
    ) +
    geom_boxplot(
        width = .12,
        ## remove outliers
        outlier.color = NA,
        alpha = 0.5
    ) +
    # Add dot plots from {ggdist} package
    ggdist::stat_dots(
        ## orientation to the left
        side = "left",
        ## move geom to the left
        justification = 1.1,
        ## adjust grouping (binning) of observations
        binwidth = .25
    ) +
    # Adjust theme
    scale_fill_tq() +
    theme_tq() +
    labs(
        title = "Raincloud Plot",
        subtitle = "Showing the Bi-Modal Distribution of 6 Cylinder Vehicles",
        x = "Engine Size (No. of Cylinders)",
        y = "Highway Fuel Economy (MPG)",
        fill = "Cylinders"
    ) +
    coord_flip()
```

# 043_hull_plots

```{r}
library(ggforce)
library(tidyquant)
library(tidyverse)
```

```{r}
g1 <- mpg %>%
    mutate(engine_size = str_c("Cylinder: ", cyl)) %>%
    ggplot(aes(displ, hwy)) +
    geom_point()
g1
```

```{r}
g2 <- g1 +
    geom_mark_hull(
        aes(fill = engine_size, label = engine_size),
        concavity = 2.8
    )
g2
```

```{r}
g3 <- g2 +
    geom_smooth(se = FALSE, span = 1.0) +
    expand_limits(y = 50) +
    theme_tq() +
    scale_fill_tq() +
    labs(
        title = "Fuel Economy (MPG) Trends by Engine Size and Displacement",
        subtitle = "Hull plot to indicate clusters / group assignment",
        y = "Highway Fuel Economy (MPG)",
        x = "Engine Displacement Volume (Liters)",
        fill = "",
        caption = "Engine size has a negative relationship to fuel economy."
    )
g3
```

# 044_dumbell_plots

```{r}
library(tidyverse)
library(tidyquant)
library(ggalt)
```

```{r}
mpg_by_year_tbl <- mpg %>%
    select(hwy, year, model, class) %>%
    pivot_wider(
        names_from   = year,
        values_from  = hwy,
        id_cols      = c(class, model),
        values_fn    = function(x) mean(x, na.rm = TRUE),
        names_prefix = "year_"
    ) %>%
    mutate(model = fct_reorder(model, year_2008)) %>%
    drop_na()
mpg_by_year_tbl
```

```{r}
g1 <- mpg_by_year_tbl %>%
    ggplot(aes(x = year_1999, xend = year_2008, y = model, group = model)) +
    geom_dumbbell(
        colour="#a3c4dc",
        colour_xend="#0e668b",
        size=4.0,
        dot_guide=TRUE,
        dot_guide_size=0.15,
        dot_guide_colour = "grey60"
    )
g1
```


```{r}
g2 <- g1 +
    labs(
        title = "Change Vehicle Fuel Economy between 1999 and 2008",
        x="Fuel Economy (MPG)", y = "Vehicle Model"
    ) +
    theme_tq() +
    theme(
        panel.grid.minor=element_blank(),
        panel.grid.major.y=element_blank(),
        panel.grid.major.x=element_line(),
        axis.ticks=element_blank(),
        panel.border=element_blank()

    )
g2
```

# 045_lollipop_plots

```{r}
library(tidyverse)
library(tidyquant)
library(ggalt)
```


```{r}
mpg_by_class_tbl <- mpg %>%
    select(hwy, model, class) %>%
    group_by(class) %>%
    summarise(mean_hwy = mean(hwy, na.rm = TRUE)) %>%
    ungroup() %>%
    mutate(class = fct_reorder(class, mean_hwy))
mpg_by_class_tbl
```


```{r}
g1 <- mpg_by_class_tbl %>%
    ggplot(aes(x = mean_hwy, y = class)) +
    geom_lollipop(
        horizontal   = TRUE,
        point.colour = "dodgerblue",
        point.size   = 10,
        color        = "#2c3e50",
        size         = 1
    )
g1
```


```{r}
g2 <- g1 +
    geom_label(
        aes(label = str_glue("Vehicle Class: {toupper(class)}
                             mpg: {round(mean_hwy)}")),
        size    = 3,
        hjust   = "outward",
        nudge_x = 2
    ) +
    expand_limits(x = 45) +
    labs(
        title = "Vehicle Fuel Economy Lollipop Plot",
        x="Fuel Economy (MPG)", y = "Vehicle Class"
    ) +
    theme_tq() +
    theme(
        panel.grid.minor=element_blank(),
        panel.grid.major.y=element_blank(),
        panel.grid.major.x=element_line(),
        axis.ticks=element_blank(),
        panel.border=element_blank()

    )
g2
```

# 046_furrr_parallel_processing

```{r}
library(tidyverse)
library(timetk)
library(lubridate)
library(furrr)
library(tictoc)
```

```{r}
sales_data_tbl <- walmart_sales_weekly %>%
    select(id, Date, Weekly_Sales) %>%
    set_names(c("id", "date", "value"))
sales_data_tbl
```


```{r}
tic()
sales_data_tbl %>%
    nest(data = c(date, value)) %>%
    mutate(model = map(data, function(df) {
        Sys.sleep(1)
        lm(value ~ month(date) + as.numeric(date), data = df)
    }))
toc()
```


```{r}
plan(multisession, workers = 6)
tic()
sales_data_tbl %>%
    nest(data = c(date, value)) %>%
    mutate(model = future_map(data, function(df) {
        Sys.sleep(1)
        lm(value ~ month(date) + as.numeric(date), data = df)
    }))
toc()
```

# 047_customer_heatmap

```{r}
library(tidyverse)
library(tidyquant)
```

```{r}
sales_by_customer_tbl <- read_rds("047_customer_heatmap/sales_by_customer.rds")
sales_by_customer_tbl
```

```{r}
prop_sales_by_customer_tbl <- sales_by_customer_tbl %>%
    group_by(bikeshop_name) %>%
    mutate(prop = quantity / sum(quantity)) %>%
    ungroup() %>%
    select(-quantity) %>%
    pivot_wider(
        id_cols     = bikeshop_name,
        names_from  = product_category,
        values_from = prop
    ) %>%
    arrange(-`Elite Road`) %>%
    mutate(bikeshop_name = fct_reorder(bikeshop_name, `Elite Road`)) %>%
    pivot_longer(
        cols      = -bikeshop_name,
        names_to  = "product_category",
        values_to = "prop"
    )
prop_sales_by_customer_tbl
```

```{r, fig.width=15, fig.height=8}
prop_sales_by_customer_tbl %>%
    ggplot(aes(product_category, bikeshop_name)) +
    geom_tile(aes(fill = prop)) +
    geom_text(aes(label = scales::percent(prop, accuracy = 1)), size = 3) +
    scale_fill_gradient(low = "white", high = palette_light()[1]) +
    labs(
        title = "Heatmap of Customer Purchasing Habits",
        subtitle = "Used to investigate Customer Similarity",
        x = "Bike Type (Product Category)",
        y = "Bikeshop (Customer)"
    ) +
    theme_tq() +
    theme(
        axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "none",
        plot.title = element_text(face = "bold"),
        plot.subtitle = element_text(face = "bold.italic")
    )
```

# 048_radiant

```{r}
library(radiant)
library(timetk)
```

```{r}
data(walmart_sales_weekly)
radiant()
```

# 049_modelstudio

```{r}
library(modelStudio)
library(DALEX)
library(tidyverse)
library(tidymodels)
```

```{r}
data_tbl <- mpg %>%
    select(hwy, manufacturer:drv, fl, class)
fit_xgboost <- boost_tree(learn_rate = 0.3) %>%
    set_mode("regression") %>%
    set_engine("xgboost") %>%
    fit(hwy ~ ., data = data_tbl)
fit_xgboost
```

```{r}
explainer <- DALEX::explain(
    model = fit_xgboost,
    data  = data_tbl,
    y     = data_tbl$hwy,
    label = "XGBoost"
)
modelStudio::modelStudio(explainer)
```

# 050_trelliscope

```{r}
library(tidyverse)
library(plotly)
library(trelliscopejs)
```

```{r}
mpg %>%
    ggplot(aes(displ, hwy)) +
    geom_point(size = 4) +
    geom_smooth(se = FALSE, span = 1) +
    facet_trelliscope(
        ~ manufacturer,
        ncol      = 4,
        nrow      = 3
    )
```


```{r}
mpg %>%
    ggplot(aes(displ, hwy)) +
    geom_point() +
    geom_smooth(se = FALSE, span = 1) +
    facet_trelliscope(
        ~ manufacturer,
        ncol      = 4,
        nrow      = 3,
        as_plotly = TRUE
    )
```

# 051_survival_plots

```{r}
library(tidyverse)
library(janitor)
library(tidyquant)
library(patchwork)
library(survival)
library(survminer)
```

```{r}
customer_churn_tbl <- read_csv("051_survival_plots/customer_churn.csv") %>%
    clean_names() %>%
    mutate(churn = ifelse(churn == "Yes", 1, 0)) %>%
    mutate_if(is.character, as_factor)
customer_churn_tbl
```

```{r}
sfit_2 <- survfit(Surv(tenure, churn) ~ contract, data = customer_churn_tbl)
g1 <- ggsurvplot(
    sfit_2,
    conf.int = TRUE,
    data     = customer_churn_tbl
)
g1
```

```{r}
g1$plot
g1$plot +
    theme_tq() +
    scale_fill_tq() +
    scale_color_tq() +
    labs(title = "Customer Churn Survival Plot")
```


```{r}
g2 <- ggsurvplot(
    sfit_2,
    conf.int = TRUE,
    data     = customer_churn_tbl,
    risk.table = TRUE
)
g2_plot <- g2$plot +
    theme_tq() +
    scale_fill_tq() +
    scale_color_tq() +
    labs(
        title = "Customer Churn Survival Plot"
    )
g2_table <- g2$table +
    theme_tq() +
    scale_fill_tq() +
    scale_color_tq() +
    theme(panel.grid = element_blank())
g2_plot / g2_table + plot_layout(heights = c(2,1))
```

```{r}
g3 <- ggsurvplot_facet(
    sfit_2,
    conf.int = TRUE,
    data     = customer_churn_tbl,
    facet.by = "gender",
    nrow     = 1
)
g3 +
    theme_tq() +
    scale_fill_tq() +
    scale_color_tq() +
    labs(title = "Survival Plot by Customer Gender")
```

# 052_modeldown

```{r}
library(tidyverse)  # Core
library(janitor)    # Clean names
library(tidymodels) # Modeling
library(DALEX)      # Explainer
library(modelDown)  # Explainable AI Report
```

```{r}
customer_churn_tbl <- read_csv("051_survival_plots/customer_churn.csv") %>%
    clean_names() %>%
    mutate_if(is.character, as_factor)
customer_churn_tbl
```

```{r}
recipe_spec <- recipe(churn ~ ., data = customer_churn_tbl) %>%
    step_rm(customer_id) %>%
    step_dummy(all_nominal_predictors(), one_hot = TRUE)
recipe_spec %>% prep() %>% bake(customer_churn_tbl)
```

```{r}
model_spec <- rand_forest(
        mode = "classification",
        mtry = 4
    ) %>%
    set_engine(engine = "randomForest")
wflw_fit_rf <- workflow() %>%
    add_recipe(recipe_spec) %>%
    add_model(model_spec) %>%
    fit(customer_churn_tbl)
wflw_fit_rf %>% predict(customer_churn_tbl)
wflw_fit_rf %>%
    predict(customer_churn_tbl, type = "prob") %>%
    pull(2)
```


```{r}
pred_func <- function(model, newdata) {
    predict(model, newdata, type = "prob") %>% pull(2)
}

pred_func(wflw_fit_rf, head(customer_churn_tbl))

explain_rf <- explain(
    model            = wflw_fit_rf,
    data             = customer_churn_tbl %>% select(-churn),
    y                = as.numeric(customer_churn_tbl$churn),
    predict_function = pred_func,
    label            = "Random Forest"
)

modelDown::modelDown(
    explain_rf,
    modules       = c("variable_importance", "variable_response"),
    output_folder = "052_modeldown/output"
)

```

# 053_ggdensity

```{r}
library(tidyverse)
library(tidyquant)
library(ggdensity)
```

```{r}
mpg %>%
    ggplot(aes(displ, hwy, fill = class)) +
    geom_point(shape = 21, size = 3) +
    scale_fill_tq() +
    theme_tq()
```

```{r, fig.width=15, fig.height=8}
g1 <- mpg %>%
    ggplot(aes(displ, hwy, fill = class)) +
    geom_hdr(probs = c(0.9, 0.5)) +
    geom_point(shape = 21, size = 3) +
    scale_fill_tq() +
    theme_tq() +
    labs(title = "High Density Regions")
g1 + facet_wrap(~ class, ncol = 2)
```

```{r, fig.width=15, fig.height=8}
g2 <- mpg %>%
    ggplot(aes(displ, hwy, fill = class)) +
    geom_hdr_lines(
        aes(color = after_stat(probs)),
        probs = c(0.9, 0.6),
        alpha = 1
    ) +
    geom_point(shape = 21, size = 2) +
    scale_color_tq() +
    scale_fill_tq() +
    theme_tq() +
    labs(title = "High Density Lines") +
    expand_limits(y = c(10, 60), x = c(0, 8))
g2 + facet_wrap(~ class)
```

# 054_explore

```{r}
library(tidyverse)
library(explore)
```

```{r}
mpg %>% explore()
mpg %>% select(-cty) %>% explore()
```

```{r}
mpg %>% describe_all()
mpg %>% describe_cat(manufacturer)
```

```{r, fig.width=15, fig.height=8}
mpg %>%
    explore_all(
        target = hwy,
        ncol   = 3
    )
```

```{r}
mpg %>%
    explore(
        target = hwy,
        var    = hwy,
        var2   = manufacturer
    )
```

```{r}
mpg %>%
    report(
        target      = hwy,
        output_dir  = "054_explore/",
        output_file = "explore_plots.html"
    )
```

# 055_ggradar

```{r}
library(ggradar)
library(tidyverse)
library(tidyquant)
library(scales)
library(corrr)
```

```{r}
vehicle_summary_tbl <- mpg %>%
    select(class, where(is_numeric), -year) %>%
    # Median Values By Vehicle Class
    group_by(class) %>%
    summarise(
        across(displ:hwy, .fns = median)
    ) %>%
    ungroup() %>%
    # Prep for ggradar (make sure to scale to 0-1)
    rename(group = class) %>%
    mutate_at(vars(-group), rescale)
vehicle_summary_tbl
```


```{r}
vehicle_summary_tbl %>% ggradar()
```

```{r}
vehicle_summary_tbl %>%
    ggradar(
        group.colours    = palette_light() %>% unname(),
        group.point.size = 0,
        group.line.width = 1,
        plot.title       = "MPG Comparison By Vehicle Class",
        fill             = TRUE,
        fill.alpha       = 0.25
    )
```

```{r, fig.width=15, fig.height=8}
vehicle_summary_tbl %>%
    ggradar(
        group.colours = palette_light() %>% unname(),
        fill          = TRUE,
        fill.alpha    = 0.25
    ) +
    # Facet
    facet_wrap(~ group, ncol = 3) +
    # Theme
    theme_void() +
    scale_color_tq() +
    theme(
        strip.text = element_text(
            size   = 12,
            colour = "white",
            margin = margin(t = 5, b = 5)
        ),
        strip.background = element_rect(fill = "#2C3E50"),
        legend.position = "none",
        plot.margin = margin(10, 10, 10, 10)
    ) +
    # Title
    labs(title = "MPG Comparison By Vehicle Class")
```

```{r}
# * Get Vehicle Similarity ----
vehicle_similarity_tbl <- vehicle_summary_tbl %>%
    # Transpose
    pivot_longer(cols = -1) %>%
    pivot_wider(
        names_from  = group,
        values_from = value
    ) %>%
    # Correlate and Arrange
    corrr::correlate() %>%
    mutate(across(where(is.numeric), .fns = ~ replace_na(., 1))) %>%
    arrange(`2seater`)
vehicle_similarity_tbl
```

```{r}
# * Reorder By Similarity ----
vehicle_summary_tbl %>%
    mutate(group = factor(group, levels = vehicle_similarity_tbl$term)) %>%
    ggradar(
        group.colours    = palette_light() %>% unname(),
        group.point.size = 0,
        group.line.width = 1,
        fill             = TRUE,
        fill.alpha       = 0.25,
        grid.label.size  = 4
    ) +
    facet_wrap(~ group, ncol = 3) +
    scale_color_tq() +
    labs(title = "Vehicle Classes Arranged By Similarity") +
    theme(
        legend.position  = "none",
        strip.background = element_rect(fill = "#2C3E50"),
        strip.text       = element_text(color = "white")
    )
```

# 056_dual_yaxis_ggplot

```{r}
library(tidyverse)
library(tidyquant)
```

```{r}
mpg_summarized_tbl <- mpg %>%
    select(-year) %>%
    group_by(class) %>%
    summarise(
        across(
            .cols  = where(is.numeric),
            .fns   = median,
            .names = "{.col}_median"
        ),
        count = n()
    ) %>%
    ungroup() %>%
    mutate(
        prop       = count / sum(count),
        all_groups = "all_groups",
        class      = fct_reorder(class, prop)
    )
mpg_summarized_tbl
```


```{r}
mpg_summarized_tbl %>%
    ggplot(aes(x = class)) +
    geom_col(aes(y = prop)) +
    geom_label(aes(
        y     = prop,
        label = str_glue("{scales::percent(prop)}")
    )) +
    geom_line(aes(y = hwy_median, group = all_groups)) +
    geom_point(aes(y = hwy_median, group = all_groups))
```

```{r}
transformer_dual_y_axis <- function(data,
                                    primary_column, secondary_column,
                                    include_y_zero = FALSE) {
    # PARAMETER SETUP
    params_tbl <- data %>%
        summarise(
            max_primary   = max(!! enquo(primary_column)),
            min_primary   = min(!! enquo(primary_column)),
            max_secondary = max(!! enquo(secondary_column)),
            min_secondary = min(!! enquo(secondary_column))
        )
    if (include_y_zero) {
        params_tbl$min_primary   <- 0
        params_tbl$min_secondary <- 0
    }
    params_tbl <- params_tbl %>%
        mutate(
            scale = (max_secondary - min_secondary) / (max_primary - min_primary),
            shift = min_primary - min_secondary
        )
    # MAKE SCALER FUNCTIONS
    scale_func <- function(x) {
        x * params_tbl$scale - params_tbl$shift
    }
    inv_func <- function(x) {
        (x + params_tbl$shift) / params_tbl$scale
    }
    # RETURN
    ret <- list(
        scale_func = scale_func,
        inv_func   = inv_func,
        params_tbl = params_tbl
    )
    return(ret)
}

# * Make A Y-Axis Transformer ----
transformer <- mpg_summarized_tbl %>%
    transformer_dual_y_axis(
        primary_column   = prop,
        secondary_column = hwy_median,
        include_y_zero   = TRUE
    )

# * How the transformer works... ----
mpg_summarized_tbl %>%
    pull(hwy_median) %>%
    transformer$inv_func() %>%
    transformer$scale_func()
```

```{r}
g1 <- mpg_summarized_tbl %>%
    ggplot(aes(x = class)) +
    geom_col(
        aes(y = prop, fill = "Vehicle Proportion (%)"),
        alpha = 0.9
    ) +
    geom_label(
        aes(
            y     = prop,
            label = str_glue("{scales::percent(prop)}"),
            color = "Vehicle Proportion (%)"
        )
    )
g1
```

```{r}
g2 <- g1 +
    geom_line(
        aes(
            y     = transformer$inv_func(hwy_median),
            group = all_groups,
            color = "Highway MPG"
        ),
        size = 1
    ) +
    geom_point(
        aes(
            y     = transformer$inv_func(hwy_median),
            group = all_groups,
            color = "Highway MPG"
        ),
        size = 5
    ) +
    geom_label(
        aes(
            y     = transformer$inv_func(hwy_median),
            label = str_glue("{hwy_median} mpg"),
            color = "Highway MPG"
        ),
        size = 3,
        nudge_y = 0.008
    ) +
    scale_y_continuous(
        labels   = scales::percent_format(),
        name     = "Vehicle Proportion (%)",
        sec.axis = sec_axis(
            trans = ~ transformer$scale_func(.),
            name  = "Highway MPG"
        )
    ) +
    expand_limits(y = c(0,0.30))
g2
```

```{r}
g3 <- g2 +
    theme_tq() +
    scale_color_manual(values = c(
        palette_light()[["red"]],
        palette_light()[["blue"]]
    )) +
    scale_fill_manual(values = palette_light()[["blue"]]) +
    theme(
        legend.position    = "none",
        axis.title.y.right = element_text(color = palette_light()[["red"]]),
        axis.text.y.right  = element_text(color = palette_light()[["red"]])
    ) +
    labs(title = "Dual Y-Axis Plot: Vehicle Class Proportion vs Fuel Economy")
g3
```

